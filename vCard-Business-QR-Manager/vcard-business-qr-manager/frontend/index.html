<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>vcard-business-qr-manager QR (vCard MVP)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --orange:#f97316;
      --orange2:#ea580c;
      --sidebar:#334155;
      --sidebar2:#475569;
      --greenbg:#dcfce7;
      --greentx:#15803d;
      --graybg:#f3f4f6;
      --graytx:#374151;
      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --radius: 12px;
      --radius2: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-synthesis-weight: none;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }
    a{color:inherit}
    button,input,select,textarea{font:inherit}
    .hidden{display:none !important}
    .container{max-width:1200px;margin:0 auto;padding:24px}

    /* Buttons */
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{background:#fafafa}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn-primary{
      background:var(--blue);
      border-color:var(--blue);
      color:#fff;
    }
    .btn-primary:hover{background:var(--blue2)}
    .btn-orange{
      background:var(--orange);
      border-color:var(--orange);
      color:#fff;
      padding:10px 16px;
    }
    .btn-orange:hover{background:var(--orange2)}
    .btn-ghost{
      background:transparent;
      border-color:transparent;
    }
    .btn-ghost:hover{background:rgba(255,255,255,.08)}
    .btn-danger{
      color:#dc2626;
    }

    /* Inputs */
    .input, .select, .textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      outline:none;
      background:#fff;
    }
    .input:focus, .select:focus, .textarea:focus{border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,.35)}
    .textarea{min-height:110px; resize:vertical}
    .label{font-size:13px; color:var(--muted); margin-bottom:6px; display:block}
    .row{display:flex; gap:16px}
    .col{flex:1}

    /* Login */
    .login-wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .login-card{
      width:100%;
      max-width:420px;
      background:var(--card);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:28px;
      border:1px solid var(--border);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:18px;
    }
    .brand .logo{
      width:34px;height:34px;border-radius:10px;background:var(--blue);
      display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
    }
    .brand h1{font-size:22px;margin:0}
    .error{color:#dc2626;font-size:13px;margin-top:6px}

    /* App layout */
    .app{min-height:100vh; display:flex}
    .sidebar{
      width:260px;
      background:var(--sidebar);
      color:#fff;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .navbtn{
      width:100%;
      text-align:left;
      padding:12px 12px;
      border-radius:12px;
      border:0;
      background:transparent;
      color:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .navbtn:hover{background:var(--sidebar2)}
    .navbtn.active{background:var(--sidebar2)}
    .content{flex:1; overflow:auto}
    .topbar{
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    /* Table */
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 3px 12px rgba(2,6,23,.04);
    }
    .table-wrap{overflow:auto}
    table{width:100%; border-collapse:collapse}
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      background:#f8fafc;
      border-bottom:1px solid var(--border);
      padding:12px 14px;
      white-space:nowrap;
    }
    tbody td{
      padding:14px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
      white-space:nowrap;
    }
    tbody tr:hover{background:#fafafa}
    .qrthumb{
      width:48px;height:48px;border:1px solid var(--border); border-radius:10px;
      display:flex;align-items:center;justify-content:center; background:#fff;
      overflow:hidden;
    }
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:12px;
      padding:6px 10px;border-radius:999px;
    }
    .badge-active{background:var(--greenbg); color:var(--greentx)}
    .badge-inactive{background:var(--graybg); color:var(--graytx)}
    .actions{display:flex;align-items:center;gap:8px; justify-content:flex-end}
    .btn-small{padding:8px 10px;border-radius:10px;font-size:13px}
    .menu{
      position:relative;
      display:inline-block;
    }
    .menu-panel{
      position:absolute;
      right:0;
      top:calc(100% + 6px);
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:var(--shadow);
      min-width:170px;
      padding:6px;
      z-index:50;
    }
    .menu-item{
      width:100%;
      text-align:left;
      border:0;
      background:transparent;
      padding:10px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
    }
    .menu-item:hover{background:#f3f4f6}
    .menu-item.danger{color:#dc2626}
    .searchbar{
      position:relative;
      padding:14px;
      border-bottom:1px solid var(--border);
    }
    .searchbar input{padding-left:40px}
    .search-icon{
      position:absolute;
      left:26px; top:50%; transform:translateY(-50%);
      color:#94a3b8;
      font-size:16px;
    }

    /* Wizard */
    .wizard{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    .wizard-body{display:flex}
    .wizard-main{
      flex:1;
      padding:24px;
      max-width:980px;
    }
    .wizard-side{
      width:420px;
      background:#fff;
      border-left:1px solid var(--border);
      padding:18px;
      position:sticky;
      top:0;
      height:calc(100vh - 0px);
      overflow:auto;
    }
    .wizard-title{font-size:20px; font-weight:700; margin:0}
    .h2{font-size:24px;font-weight:800;margin:0 0 16px}
    .stepper{
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px 18px;
      border-top:1px solid var(--border);
      background:#fff;
      position:sticky;
      bottom:0;
    }
    .step{
      display:flex;align-items:center;gap:8px;color:var(--muted); font-size:13px;
    }
    .dot{
      width:26px;height:26px;border-radius:999px;border:1px solid var(--border);
      display:inline-flex;align-items:center;justify-content:center;
      background:#fff;
    }
    .step.active{color:var(--text)}
    .step.active .dot{background:#dbeafe;border-color:#93c5fd}
    .sep{color:#cbd5e1}
    .type-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
    }
    .type-card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      text-align:left;
      cursor:pointer;
      background:#fff;
    }
    .type-card.enabled{
      border:2px solid #60a5fa;
      background:#eff6ff;
    }
    .type-card.disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .type-card h3{margin:0 0 6px; font-size:16px}
    .type-card p{margin:0; color:var(--muted); font-size:13px}

    /* Collapsible */
    .section{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .section-h{
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .section-h .left{display:flex;align-items:center;gap:10px}
    .section-h .icon{
      width:30px;height:30px;border-radius:10px;background:#f1f5f9;
      display:flex;align-items:center;justify-content:center;
    }
    .section-h .title{font-weight:700}
    .section-b{
      border-top:1px solid var(--border);
      background:#f8fafc;
      padding:14px;
    }
    .chev{transition:transform .18s ease}
    .chev.open{transform:rotate(180deg)}

    /* Presets + chips */
    .preset-row{display:flex; gap:8px; flex-wrap:wrap}
    .preset{
      width:44px;height:44px;border-radius:12px;border:2px solid var(--border);
      overflow:hidden; display:flex;
      cursor:pointer;
      background:#fff;
    }
    .preset:hover{border-color:#93c5fd}
    .preset div{flex:1}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      cursor:pointer;background:#fff;
      font-size:13px;
    }
    .chip.active{border-color:#60a5fa;background:#eff6ff}

    /* Upload */
    .drop{
      border:2px dashed #cbd5e1;
      border-radius:14px;
      padding:18px;
      text-align:center;
      background:#fff;
    }
    .drop img{border-radius:999px}
    .smallmuted{font-size:12px;color:#94a3b8}

    /* Phone preview */
    .toggle{
      display:flex;gap:8px;margin-bottom:12px;
    }
    .toggle .tab{
      flex:1;
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      cursor:pointer;background:#fff;
    }
    .toggle .tab.active{
      background:var(--blue);
      border-color:var(--blue);
      color:#fff;
    }
    .phone{
      width:300px;
      height:600px;
      margin:0 auto;
      border:5px solid #0b0b0b;
      border-radius:34px;
      padding:14px;
      background:#111;
    }
    .screen{
      height:100%;
      border-radius:26px;
      padding:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      overflow:hidden;
    }
    .time{font-size:12px;color:rgba(255,255,255,.85); align-self:flex-start}
    .avatar{
      width:92px;height:92px;border-radius:999px;background:#fff;object-fit:cover;
      border:6px solid rgba(255,255,255,.35);
    }
    .name{
      color:#fff;font-size:20px;font-weight:800;margin-top:4px;text-align:center;
    }
    .addbtn{
      background:#0b0b0b;color:#fff;border:0;border-radius:999px;padding:10px 16px;
      display:flex;gap:8px;align-items:center;cursor:pointer;font-size:13px;
    }
    .cards{
      width:100%;
      background:#fff;border-radius:16px;padding:12px; flex:1;
      display:flex;flex-direction:column;gap:10px;
    }
    .rowitem{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px;border-radius:12px;cursor:pointer;
    }
    .rowitem:hover{background:#f8fafc}
    .rowitem .l{display:flex;gap:10px;align-items:center}
    .arrow{color:#94a3b8}

    /* QR preview */
    .qrbox{
      width:240px;height:240px;border-radius:18px;border:1px solid var(--border);
      background:#fff;display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      margin:0 auto;
    }
    .mono{font-family:var(--mono)}
    .hint{color:var(--muted); font-size:13px}
    .toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      background:#0f172a; color:#fff; padding:10px 14px; border-radius:999px;
      box-shadow:var(--shadow);
      font-size:13px;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
    @media (max-width: 1080px){
      .wizard-body{flex-direction:column}
      .wizard-side{width:100%; position:relative; height:auto; border-left:0; border-top:1px solid var(--border)}
      .phone{height:560px}
    }
    @media (max-width: 860px){
      .sidebar{display:none}
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="loginView" class="login-wrap">
    <div class="login-card">
      <div class="brand">
        <div class="logo">QR</div>
        <h1>vcard-business-qr-manager QR</h1>
      </div>

      <form id="loginForm">
        <label class="label">Email</label>
        <input id="loginEmail" class="input" type="email" value="admin@vcard-business-qr-manager.local" required />

        <div style="height:10px"></div>

        <label class="label">Password</label>
        <input id="loginPassword" class="input" type="password" value="Admin123!" required />

        <div id="loginError" class="error hidden"></div>

        <div style="height:14px"></div>

        <button id="loginBtn" class="btn btn-primary" type="submit" style="width:100%; justify-content:center;">
          Login
        </button>
      </form>

      <div class="hint" style="margin-top:12px">
        Backend: <span class="mono">http://localhost:8080</span>
      </div>
    </div>
  </div>

  <!-- APP (Dashboard) -->
  <div id="appView" class="app hidden">
    <aside class="sidebar">
      <div class="brand" style="margin:6px 0 10px">
        <div class="logo" style="background:#60a5fa">QR</div>
        <h1 style="font-size:18px;margin:0">vcard-business-qr-manager QR</h1>
      </div>

      <button class="navbtn" id="navAnalytics">üìä <span>Analytics</span></button>
      <button class="navbtn active" id="navQRCodes">üî≥ <span>QR codes</span></button>
      <button class="navbtn" id="navAccount">üë§ <span>Account</span></button>

      <div style="flex:1"></div>

      <button class="navbtn" id="logoutBtn">üö™ <span>Log out</span></button>
    </aside>

    <main class="content">
      <!-- QR Codes List -->
      <div id="listPage">
        <div class="container">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px">
            <h1 style="margin:0; font-size:30px; font-weight:900;">QR codes</h1>
            <button class="btn btn-orange" id="createBtn">‚ûï Create QR code</button>
          </div>

          <div class="card">
            <div class="searchbar">
              <div class="search-icon">üîé</div>
              <input id="searchInput" class="input" placeholder="Search by QR code name" />
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:46px"><input type="checkbox" /></th>
                    <th>QR code name</th>
                    <th>QR code type</th>
                    <th>Scans</th>
                    <th>Status</th>
                    <th>Creation date</th>
                    <th style="text-align:right"> </th>
                  </tr>
                </thead>
                <tbody id="qrTbody">
                  <tr><td colspan="7" style="padding:18px; color:var(--muted)">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- WIZARD -->
      <div id="wizardPage" class="wizard hidden">
        <div class="topbar">
          <div style="display:flex;align-items:center;gap:14px">
            <button class="btn btn-ghost" id="wizardBackBtn">‚Üê Back</button>
            <div>
              <div class="wizard-title" id="wizardTitle">Create vCard QR code</div>
              <div class="hint">vCard only (MVP)</div>
            </div>
          </div>
          <div class="hint"> </div>
        </div>

        <div class="wizard-body">
          <div class="wizard-main">
            <!-- Step 1 -->
            <div id="step1">
              <div class="h2">Choose QR code type</div>
              <div class="type-grid">
                <div class="type-card" data-type="vcard">
                  <h3>vCard</h3>
                  <p>Share your electronic business card</p>
                </div>
                <div class="type-card" data-type="businesspage">
                  <h3>Business Page</h3>
                  <p>Share your business information</p>
                </div>
                <div class="type-card disabled"><h3>Website URL</h3><p>Coming soon</p></div>
                <div class="type-card disabled"><h3>PDF</h3><p>Coming soon</p></div>
                <div class="type-card disabled"><h3>Social Media</h3><p>Coming soon</p></div>
                <div class="type-card disabled"><h3>Video</h3><p>Coming soon</p></div>
                <div class="type-card disabled"><h3>Wi-Fi</h3><p>Coming soon</p></div>
                <div class="type-card disabled"><h3>Menu</h3><p>Coming soon</p></div>
              </div>

              <div style="margin-top:16px; display:flex; justify-content:flex-end">
                <button class="btn btn-primary" id="toStep2">Next ‚Üí</button>
              </div>
            </div>

            <!-- Step 2 vCard -->
            <div id="step2vcard" class="hidden">
              <div class="h2">Add content to the vCard QR code</div>

              <div style="display:flex; flex-direction:column; gap:12px">
                <!-- Design + Customize -->
                <div class="section" data-section="design" data-open="true">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üé®</div>
                      <div>
                        <div class="title">Design and customize</div>
                        <div class="hint">Choose your color scheme</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b">
                    <div class="label">Color presets</div>
                    <div class="preset-row" id="presetRow"></div>

                    <div style="height:14px"></div>

                    <div class="row">
                      <div class="col">
                        <label class="label">Primary color</label>
                        <input id="primaryColor" class="input" type="color" value="#6594FF" style="height:44px; padding:6px" />
                      </div>
                      <div class="col">
                        <label class="label">Secondary color</label>
                        <input id="secondaryColor" class="input" type="color" value="#FFFFFF" style="height:44px; padding:6px" />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- About you -->
                <div class="section" data-section="about" data-open="true">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üë§</div>
                      <div>
                        <div class="title">About you</div>
                        <div class="hint">Fill in the information you would like to showcase</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b">
                    <label class="label">Full name*</label>
                    <input id="fullName" class="input" placeholder="e.g. Jane Cooper" />

                    <div style="height:12px"></div>

                    <label class="label">Image</label>
                    <div class="drop">
                      <input id="profileFile" type="file" accept="image/*" class="hidden" />
                      <div id="profilePreviewWrap" class="hidden" style="margin-bottom:10px">
                        <img id="profilePreview" alt="Profile" class="avatar" style="width:84px;height:84px;border:0" />
                      </div>
                      <button type="button" class="btn" id="profileUploadBtn">‚¨Ü Upload image</button>
                      <div class="smallmuted" style="margin-top:8px">jpg, png, svg ‚Ä¢ Max 5MB</div>
                      <div id="profilePath" class="smallmuted mono" style="margin-top:6px"></div>
                    </div>
                  </div>
                </div>

                <!-- Contact -->
                <div class="section" data-section="contact" data-open="false">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üìû</div>
                      <div>
                        <div class="title">Contact details</div>
                        <div class="hint">Phone, email, website</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b hidden">
                    <div style="display:flex; flex-direction:column; gap:10px">
                      <input id="phone" class="input" placeholder="Phone" />
                      <input id="email" class="input" placeholder="Email" />
                      <input id="website" class="input" placeholder="Website" />
                    </div>
                  </div>
                </div>

                <!-- Company -->
                <div class="section" data-section="company" data-open="false">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üè¢</div>
                      <div>
                        <div class="title">Company details</div>
                        <div class="hint">Company, title</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b hidden">
                    <div style="display:flex; flex-direction:column; gap:10px">
                      <input id="company" class="input" placeholder="Company" />
                      <input id="title" class="input" placeholder="Title" />
                    </div>
                  </div>
                </div>

                <!-- Summary -->
                <div class="section" data-section="summary" data-open="false">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üìù</div>
                      <div>
                        <div class="title">Summary</div>
                        <div class="hint">Short bio</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b hidden">
                    <textarea id="summary" class="textarea" placeholder="Add a summary..."></textarea>
                  </div>
                </div>

                <!-- Social (minimal MVP) -->
                <div class="section" data-section="social" data-open="false">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üëç</div>
                      <div>
                        <div class="title">Social networks</div>
                        <div class="hint">Add social links (MVP)</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b hidden">
                    <div class="hint" style="margin-bottom:10px">Pick a platform then add a URL.</div>
                    <div class="row" style="align-items:flex-end">
                      <div class="col">
                        <label class="label">Platform</label>
                        <select id="socialPlatform" class="select">
                          <option value="linkedin">LinkedIn</option>
                          <option value="instagram">Instagram</option>
                          <option value="facebook">Facebook</option>
                          <option value="x">X</option>
                          <option value="tiktok">TikTok</option>
                          <option value="youtube">YouTube</option>
                          <option value="telegram">Telegram</option>
                          <option value="whatsapp">WhatsApp</option>
                        </select>
                      </div>
                      <div class="col">
                        <label class="label">URL</label>
                        <input id="socialUrl" class="input" placeholder="https://..." />
                      </div>
                      <div>
                        <button class="btn btn-primary" type="button" id="addSocialBtn">Add</button>
                      </div>
                    </div>
                    <div style="height:10px"></div>
                    <div id="socialList" style="display:flex;flex-direction:column;gap:8px"></div>
                  </div>
                </div>

                <!-- QR name -->
                <div class="section" data-section="qrname" data-open="true">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">‚úèÔ∏è</div>
                      <div>
                        <div class="title">QR code name</div>
                        <div class="hint">Set a name for your QR code</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b">
                    <input id="qrName" class="input" placeholder="e.g. My Business Card" />
                  </div>
                </div>
              </div>

              <div style="margin-top:16px; display:flex; justify-content:space-between">
                <button class="btn" id="backTo1">‚Üê Back</button>
                <button class="btn btn-primary" id="toStep3">Next ‚Üí</button>
              </div>
            </div>

            <!-- Step 2 Business Page -->
            <div id="step2business" class="hidden">
              <div class="h2">Add content to the Business Page QR code</div>

              <div style="display:flex; flex-direction:column; gap:12px">
                <!-- Design + Customize -->
                <div class="section" data-section="businessdesign" data-open="true">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üé®</div>
                      <div>
                        <div class="title">Design and customize</div>
                        <div class="hint">Choose your color scheme</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b">
                    <div class="label">Color presets</div>
                    <div class="preset-row" id="businessPresetRow"></div>

                    <div style="height:14px"></div>

                    <div class="row">
                      <div class="col">
                        <label class="label">Primary color</label>
                        <input id="businessPrimaryColor" class="input" type="color" value="#6594FF" style="height:44px; padding:6px" />
                      </div>
                      <div class="col">
                        <label class="label">Secondary color</label>
                        <input id="businessSecondaryColor" class="input" type="color" value="#FFFFFF" style="height:44px; padding:6px" />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Add Image -->
                <div class="section" data-section="businessimage" data-open="true">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üñºÔ∏è</div>
                      <div>
                        <div class="title">Add Image</div>
                        <div class="hint">Upload an image for your business</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b">
                    <label class="label">Upload image (jpg, png, svg)</label>
                    <div class="drop">
                      <input id="businessImageFile" type="file" accept="image/*" class="hidden" />
                      <div id="businessImagePreviewWrap" class="hidden" style="margin-bottom:10px">
                        <img id="businessImagePreview" alt="Business" style="width:200px;border-radius:12px;object-fit:cover" />
                      </div>
                      <button type="button" class="btn" id="businessImageUploadBtn">‚¨Ü Upload image</button>
                      <div class="smallmuted" style="margin-top:8px">Maximum size: 5MB</div>
                      <div id="businessImagePath" class="smallmuted mono" style="margin-top:6px"></div>
                    </div>
                  </div>
                </div>

                <!-- Business information -->
                <div class="section" data-section="businessinfo" data-open="true">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">‚ÑπÔ∏è</div>
                      <div>
                        <div class="title">Business information</div>
                        <div class="hint">Provide details about your business</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b">
                    <div style="display:flex; flex-direction:column; gap:10px">
                      <div>
                        <label class="label">Company name*</label>
                        <input id="businessCompanyName" class="input" placeholder="e.g. My Company" />
                      </div>
                      <div class="row">
                        <div class="col">
                          <label class="label">Title</label>
                          <input id="businessTitle" class="input" placeholder="e.g. Animation Studio" />
                        </div>
                      </div>
                      <div>
                        <label class="label">Subtitle</label>
                        <input id="businessSubtitle" class="input" placeholder="e.g. Creating animated videos since 1994" />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Contact information -->
                <div class="section" data-section="businesscontact" data-open="false">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üìû</div>
                      <div>
                        <div class="title">Contact information</div>
                        <div class="hint">Provide contact details</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b hidden">
                    <div style="display:flex; flex-direction:column; gap:10px">
                      <div>
                        <label class="label">Full name</label>
                        <input id="businessFullName" class="input" placeholder="e.g. Mike Smith" />
                      </div>
                      <div>
                        <label class="label">Phone number</label>
                        <input id="businessPhone" class="input" placeholder="e.g. +1809999999" />
                      </div>
                      <div>
                        <label class="label">Alternative phone number</label>
                        <input id="businessAltPhone" class="input" placeholder="e.g. +1809999999" />
                      </div>
                      <div>
                        <label class="label">Website</label>
                        <input id="businessWebsite" class="input" placeholder="e.g. https://pauljones.com" />
                      </div>
                      <div>
                        <label class="label">Email</label>
                        <input id="businessEmail" class="input" placeholder="e.g. name@email.com" />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Location -->
                <div class="section" data-section="businesslocation" data-open="false">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üìç</div>
                      <div>
                        <div class="title">Location</div>
                        <div class="hint">Provide your business address if you have one</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b hidden">
                    <div style="display:flex; flex-direction:column; gap:10px">
                      <div>
                        <label class="label">Street</label>
                        <input id="businessStreet" class="input" placeholder="e.g. Spring Avenue, 9/18" />
                      </div>
                      <div class="row">
                        <div class="col">
                          <label class="label">Postal code</label>
                          <input id="businessPostalCode" class="input" placeholder="e.g. 10005" />
                        </div>
                        <div class="col">
                          <label class="label">City</label>
                          <input id="businessCity" class="input" placeholder="e.g. New York City" />
                        </div>
                      </div>
                      <div class="row">
                        <div class="col">
                          <label class="label">State</label>
                          <input id="businessState" class="input" placeholder="e.g. New York" />
                        </div>
                        <div class="col">
                          <label class="label">Country</label>
                          <input id="businessCountry" class="input" placeholder="e.g. United States" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Opening hours -->
                <div class="section" data-section="businesshours" data-open="false">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üïê</div>
                      <div>
                        <div class="title">Opening hours</div>
                        <div class="hint">If applicable, provide your business hours</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b hidden">
                    <div class="chips" style="margin-bottom:12px">
                      <button class="chip active" data-hours-mode="ampm" type="button">AM/PM</button>
                      <button class="chip" data-hours-mode="24hrs" type="button">24 hrs</button>
                      <button class="chip" data-hours-mode="24/7" type="button">Open 24/7</button>
                    </div>
                    <div id="hoursContainer" style="display:flex; flex-direction:column; gap:10px">
                      <div class="row" style="align-items:center">
                        <div style="width:50px">
                          <input type="checkbox" id="hoursMonFri" checked style="width:18px;height:18px" />
                        </div>
                        <div style="flex:1"><label for="hoursMonFri">Monday - Friday</label></div>
                        <div class="col">
                          <input id="hoursMonFriStart" class="input" placeholder="10:00 AM" />
                        </div>
                        <div class="col">
                          <input id="hoursMonFriEnd" class="input" placeholder="08:00 PM" />
                        </div>
                      </div>
                      <div style="text-align:center; color:var(--muted)">OR</div>
                      <div class="row" style="align-items:center">
                        <div style="width:50px">
                          <input type="checkbox" id="hoursMon" />
                        </div>
                        <div style="flex:1"><label for="hoursMon">Monday</label></div>
                        <div class="col">
                          <input id="hoursMon Start" class="input" placeholder="10:00 AM" />
                        </div>
                        <div class="col">
                          <input id="hoursMonEnd" class="input" placeholder="08:00 PM" />
                        </div>
                      </div>
                      <div class="row" style="align-items:center">
                        <div style="width:50px">
                          <input type="checkbox" id="hoursTue" />
                        </div>
                        <div style="flex:1"><label for="hoursTue">Tuesday</label></div>
                        <div class="col">
                          <input id="hoursTueStart" class="input" placeholder="10:00 AM" />
                        </div>
                        <div class="col">
                          <input id="hoursTueEnd" class="input" placeholder="08:00 PM" />
                        </div>
                      </div>
                      <div class="row" style="align-items:center">
                        <div style="width:50px">
                          <input type="checkbox" id="hoursWed" />
                        </div>
                        <div style="flex:1"><label for="hoursWed">Wednesday</label></div>
                        <div class="col">
                          <input id="hoursWedStart" class="input" placeholder="10:00 AM" />
                        </div>
                        <div class="col">
                          <input id="hoursWedEnd" class="input" placeholder="08:00 PM" />
                        </div>
                      </div>
                      <div class="row" style="align-items:center">
                        <div style="width:50px">
                          <input type="checkbox" id="hoursThu" />
                        </div>
                        <div style="flex:1"><label for="hoursThu">Thursday</label></div>
                        <div class="col">
                          <input id="hoursThuStart" class="input" placeholder="10:00 AM" />
                        </div>
                        <div class="col">
                          <input id="hoursThuEnd" class="input" placeholder="08:00 PM" />
                        </div>
                      </div>
                      <div class="row" style="align-items:center">
                        <div style="width:50px">
                          <input type="checkbox" id="hoursFri" />
                        </div>
                        <div style="flex:1"><label for="hoursFri">Friday</label></div>
                        <div class="col">
                          <input id="hoursFriStart" class="input" placeholder="10:00 AM" />
                        </div>
                        <div class="col">
                          <input id="hoursFriEnd" class="input" placeholder="08:00 PM" />
                        </div>
                      </div>
                      <div class="row" style="align-items:center">
                        <div style="width:50px">
                          <input type="checkbox" id="hoursSat" />
                        </div>
                        <div style="flex:1"><label for="hoursSat">Saturday</label></div>
                        <div class="col">
                          <input id="hoursSatStart" class="input" placeholder="10:00 AM" />
                        </div>
                        <div class="col">
                          <input id="hoursSatEnd" class="input" placeholder="08:00 PM" />
                        </div>
                      </div>
                      <div class="row" style="align-items:center">
                        <div style="width:50px">
                          <input type="checkbox" id="hoursSun" />
                        </div>
                        <div style="flex:1"><label for="hoursSun">Sunday</label></div>
                        <div class="col">
                          <input id="hoursSunStart" class="input" placeholder="10:00 AM" />
                        </div>
                        <div class="col">
                          <input id="hoursSunEnd" class="input" placeholder="08:00 PM" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Facilities -->
                <div class="section" data-section="businessfacilities" data-open="false">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">‚ò∫Ô∏è</div>
                      <div>
                        <div class="title">Facilities</div>
                        <div class="hint">Select relevant icons below to showcase business facilities</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b hidden">
                    <div class="chips" id="facilitiesChips" style="flex-wrap:wrap">
                      <button class="chip" data-facility="wifi" type="button">üì∂ Wi-Fi</button>
                      <button class="chip" data-facility="train" type="button">üöä Train</button>
                      <button class="chip" data-facility="seating" type="button">ü™ë Seating</button>
                      <button class="chip" data-facility="taxi" type="button">üöï Taxi</button>
                      <button class="chip" data-facility="accessible" type="button">‚ôø Accessible</button>
                      <button class="chip" data-facility="accommodation" type="button">üõèÔ∏è Accommodation</button>
                      <button class="chip" data-facility="toilet" type="button">üöΩ Toilet</button>
                      <button class="chip" data-facility="cafe" type="button">‚òï Cafe</button>
                      <button class="chip" data-facility="childfriendly" type="button">üë∂ Child-friendly</button>
                      <button class="chip" data-facility="bar" type="button">üç∫ Bar</button>
                      <button class="chip" data-facility="petfriendly" type="button">üêæ Pet-friendly</button>
                      <button class="chip" data-facility="restaurant" type="button">üçΩÔ∏è Restaurant</button>
                      <button class="chip" data-facility="parking" type="button">üÖøÔ∏è Parking</button>
                    </div>
                  </div>
                </div>

                <!-- About the company -->
                <div class="section" data-section="businessabout" data-open="false">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üè¢</div>
                      <div>
                        <div class="title">About the company</div>
                        <div class="hint">Provide a summary about your company</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b hidden">
                    <label class="label">Summary</label>
                    <textarea id="businessSummary" class="textarea" placeholder="e.g. Our company provides a wide variety of services"></textarea>
                  </div>
                </div>

                <!-- Social networks -->
                <div class="section" data-section="businesssocial" data-open="false">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">üëç</div>
                      <div>
                        <div class="title">Social networks</div>
                        <div class="hint">Click on the icons below to add social media channels you'd like to display</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b hidden">
                    <div class="hint" style="margin-bottom:10px">Pick a platform then add a URL.</div>
                    <div class="row" style="align-items:flex-end">
                      <div class="col">
                        <label class="label">Platform</label>
                        <select id="businessSocialPlatform" class="select">
                          <option value="facebook">Facebook</option>
                          <option value="instagram">Instagram</option>
                          <option value="twitter">Twitter/X</option>
                          <option value="linkedin">LinkedIn</option>
                          <option value="tiktok">TikTok</option>
                          <option value="youtube">YouTube</option>
                          <option value="whatsapp">WhatsApp</option>
                          <option value="telegram">Telegram</option>
                          <option value="snapchat">Snapchat</option>
                          <option value="yelp">Yelp</option>
                          <option value="google">Google</option>
                        </select>
                      </div>
                      <div class="col">
                        <label class="label">URL</label>
                        <input id="businessSocialUrl" class="input" placeholder="https://..." />
                      </div>
                      <div>
                        <button class="btn btn-primary" type="button" id="addBusinessSocialBtn">Add</button>
                      </div>
                    </div>
                    <div style="height:10px"></div>
                    <div id="businessSocialList" style="display:flex;flex-direction:column;gap:8px"></div>
                  </div>
                </div>

                <!-- QR name -->
                <div class="section" data-section="businessqrname" data-open="true">
                  <div class="section-h">
                    <div class="left">
                      <div class="icon">‚úèÔ∏è</div>
                      <div>
                        <div class="title">QR code name</div>
                        <div class="hint">Set a name for your QR code</div>
                      </div>
                    </div>
                    <div class="chev">‚åÑ</div>
                  </div>
                  <div class="section-b">
                    <input id="businessQrName" class="input" placeholder="e.g. My Business QR" />
                  </div>
                </div>
              </div>

              <div style="margin-top:16px; display:flex; justify-content:space-between">
                <button class="btn" id="backTo1Business">‚Üê Back</button>
                <button class="btn btn-primary" id="toStep3Business">Next ‚Üí</button>
              </div>
            </div>

            <!-- Step 3 -->
            <div id="step3" class="hidden">
              <div class="h2">Customize QR design</div>

              <div class="card" style="padding:16px">
                <div style="display:flex;flex-direction:column;gap:16px">
                  <div>
                    <div class="label">Pattern</div>
                    <div class="chips" id="patternChips"></div>
                  </div>

                  <div>
                    <div class="label">Frame</div>
                    <div class="chips" id="frameChips"></div>
                  </div>

                  <div>
                    <div class="label">Logo (optional)</div>
                    <div class="drop">
                      <input id="logoFile" type="file" accept="image/*" class="hidden" />
                      <div id="logoPreviewWrap" class="hidden" style="margin-bottom:10px">
                        <img id="logoPreview" alt="Logo" style="width:74px;height:74px;border-radius:16px;object-fit:contain;background:#fff;border:1px solid var(--border);padding:8px" />
                      </div>
                      <button type="button" class="btn" id="logoUploadBtn">‚¨Ü Upload logo</button>
                      <div class="smallmuted" style="margin-top:8px">jpg, png, svg ‚Ä¢ Max 5MB</div>
                      <div id="logoPath" class="smallmuted mono" style="margin-top:6px"></div>
                    </div>
                  </div>

                  <div class="hint">
                    Final QR is generated by backend. If your backend doesn‚Äôt support patterns/frames yet,
                    the UI will still save the chosen values for later.
                  </div>
                </div>
              </div>

              <div style="margin-top:16px; display:flex; justify-content:space-between">
                <button class="btn" id="backTo2">‚Üê Back</button>
                <button class="btn btn-primary" id="saveBtn">Create QR Code</button>
              </div>
            </div>
          </div>

          <!-- Side preview -->
          <div class="wizard-side">
            <div class="toggle">
              <button class="tab active" id="tabPreview">Preview</button>
              <button class="tab" id="tabQR">QR code</button>
            </div>

            <div id="previewPane">
              <div class="phone">
                <div class="screen" id="phoneScreen">
                  <div class="time">18:45</div>
                  <img id="phoneAvatar" class="avatar hidden" alt="avatar"/>
                  <div id="phoneName" class="name hidden"></div>
                  <button class="addbtn" type="button">‚ûï Add contact</button>

                  <div class="cards" id="phoneCards">
                    <!-- items inserted -->
                  </div>
                </div>
              </div>
            </div>

            <div id="qrPane" class="hidden">
              <div class="qrbox" id="qrPreviewBox">
                <div class="hint">Save to generate QR preview</div>
              </div>
              <div class="hint" style="margin-top:12px">
                Tip: downloads are available on the dashboard after saving.
              </div>
            </div>
          </div>
        </div>

        <div class="stepper">
          <div class="step" id="st1"><span class="dot">1</span> Choose Type</div>
          <div class="sep">‚Ä∫</div>
          <div class="step" id="st2"><span class="dot">2</span> Add content</div>
          <div class="sep">‚Ä∫</div>
          <div class="step" id="st3"><span class="dot">3</span> Customize</div>
        </div>
      </div>
    </main>
  </div>

  <div id="toast" class="toast">Copied</div>

<script>
/** =========================
 *  Config
 *  ========================= */
// Auto-detect server URL from browser location
const API_BASE = window.location.origin;
const API_URL  = API_BASE + "/api";

/** =========================
 *  Minimal API client
 *  ========================= */
const api = {
  token: localStorage.getItem("token") || "",

  setToken(t){
    this.token = t;
    localStorage.setItem("token", t);
  },
  clearToken(){
    this.token = "";
    localStorage.removeItem("token");
  },

  async request(path, opts={}){
    const headers = Object.assign({}, opts.headers || {});
    if (!(opts.body instanceof FormData)) {
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
    }
    if (this.token) headers["Authorization"] = "Bearer " + this.token;

    const res = await fetch(API_URL + path, { ...opts, headers });
    if (!res.ok) {
      const text = await res.text().catch(()=> "");
      throw new Error(`${res.status} ${res.statusText} ${text}`);
    }
    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) return res.json();
    return res.text();
  },

  login(email,password){
    return this.request("/auth/login", {
      method:"POST",
      body: JSON.stringify({ email, password })
    }).then(d => { this.setToken(d.token); return d; });
  },

  getQRCodes(search=""){
    return this.request("/qr-codes?search=" + encodeURIComponent(search));
  },
  getQRCode(id){
    return this.request("/qr-codes/" + encodeURIComponent(id));
  },
  createQRCode(payload){
    return this.request("/qr-codes", { method:"POST", body: JSON.stringify(payload) });
  },
  updateQRCode(id, payload){
    return this.request("/qr-codes/" + encodeURIComponent(id), { method:"PUT", body: JSON.stringify(payload) });
  },
  deleteQRCode(id){
    return this.request("/qr-codes/" + encodeURIComponent(id), { method:"DELETE" });
  },
  toggleStatus(id, status){
    return this.request(`/qr-codes/${encodeURIComponent(id)}/status`, {
      method:"PATCH",
      body: JSON.stringify({ status })
    });
  },
  async uploadFile(file){
    const fd = new FormData();
    fd.append("file", file);
    const res = await fetch(API_URL + "/uploads", {
      method:"POST",
      headers: this.token ? { "Authorization": "Bearer " + this.token } : {},
      body: fd
    });
    if (!res.ok) throw new Error("Upload failed: " + res.statusText);
    return res.json();
  },

  publicUrl(shortCode){
    return `${API_BASE}/q/${shortCode}`;
  },
  renderUrl(id, format, size=512){
    return `${API_URL}/qr-codes/${encodeURIComponent(id)}/render.${format}` + (format==="svg" ? "" : `?size=${size}`);
  }
};

/** =========================
 *  UI helpers
 *  ========================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 1200);
}

function fmtDate(iso){
  try { return new Date(iso).toLocaleDateString(); } catch { return iso || ""; }
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

/** =========================
 *  App state & navigation
 *  ========================= */
let view = "list"; // list | wizard
let editId = null;
let qrType = "vcard"; // vcard | businesspage

const state = {
  // vcard
  vcard: {
    fullName: "",
    phone: "",
    email: "",
    website: "",
    company: "",
    title: "",
    summary: "",
    profileImage: "", // server URL path like /files/...
    socialLinks: []
  },
  // business page
  businesspage: {
    companyName: "",
    title: "",
    subtitle: "",
    businessImage: "",
    fullName: "",
    phone: "",
    altPhone: "",
    website: "",
    email: "",
    street: "",
    postalCode: "",
    city: "",
    state: "",
    country: "",
    hoursMode: "ampm",
    openingHours: {
      monFri: { enabled: true, start: "10:00 AM", end: "08:00 PM" },
      mon: { enabled: false, start: "", end: "" },
      tue: { enabled: false, start: "", end: "" },
      wed: { enabled: false, start: "", end: "" },
      thu: { enabled: false, start: "", end: "" },
      fri: { enabled: false, start: "", end: "" },
      sat: { enabled: false, start: "", end: "" },
      sun: { enabled: false, start: "", end: "" }
    },
    facilities: [],
    summary: "",
    socialLinks: []
  },
  design: {
    primaryColor: "#6594FF",
    secondaryColor: "#FFFFFF",
    pattern: "square",
    frame: "none",
    logo: "" // server URL path
  },
  qrName: "",
  step: 1
};

/** =========================
 *  Login
 *  ========================= */
$("#loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  $("#loginError").classList.add("hidden");
  $("#loginBtn").disabled = true;

  try{
    const email = $("#loginEmail").value.trim();
    const password = $("#loginPassword").value;
    await api.login(email, password);
    showApp();
  }catch(err){
    $("#loginError").textContent = "Invalid credentials or backend not running.";
    $("#loginError").classList.remove("hidden");
  }finally{
    $("#loginBtn").disabled = false;
  }
});

function showLogin(){
  $("#loginView").classList.remove("hidden");
  $("#appView").classList.add("hidden");
}
function showApp(){
  $("#loginView").classList.add("hidden");
  $("#appView").classList.remove("hidden");
  showList();
}

/** =========================
 *  Dashboard list
 *  ========================= */
$("#logoutBtn").addEventListener("click", ()=>{
  api.clearToken();
  showLogin();
});

$("#createBtn").addEventListener("click", ()=>{
  editId = null;
  resetWizard();
  showWizard();
});

$("#searchInput").addEventListener("input", debounce(()=>{
  loadList();
}, 250));

function debounce(fn, ms){
  let t=null;
  return (...args)=>{
    clearTimeout(t);
    t=setTimeout(()=>fn(...args), ms);
  };
}

async function loadList(){
  const tbody = $("#qrTbody");
  tbody.innerHTML = `<tr><td colspan="7" style="padding:18px; color:var(--muted)">Loading...</td></tr>`;
  try{
    const search = $("#searchInput").value.trim();
    const items = await api.getQRCodes(search);

    if (!items || items.length===0){
      tbody.innerHTML = `<tr><td colspan="7" style="padding:18px; color:var(--muted)">No QR codes found</td></tr>`;
      return;
    }

    tbody.innerHTML = "";
    for (const qr of items){
      const tr = document.createElement("tr");

      const statusBadge = qr.status === "active"
        ? `<span class="badge badge-active">‚úì Active</span>`
        : `<span class="badge badge-inactive">Inactive</span>`;

      tr.innerHTML = `
        <td><input type="checkbox" /></td>
        <td>
          <div style="display:flex;align-items:center;gap:12px">
            <div class="qrthumb">
              <img alt="qr" src="${api.renderUrl(qr.id,'png',128)}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"/>
            </div>
            <div style="font-weight:700">${escapeHtml(qr.name)}</div>
          </div>
        </td>
        <td>vCard</td>
        <td>${qr.scans ?? 0}</td>
        <td>${statusBadge}</td>
        <td style="color:var(--muted)">${fmtDate(qr.createdAt)}</td>
        <td style="text-align:right">
          <div class="actions">
            <button class="btn btn-small" data-act="share">üîó Share</button>

            <div class="menu">
              <button class="btn btn-small" data-act="download">‚¨á Download</button>
              <div class="menu-panel hidden" data-panel="download">
                <button class="menu-item" data-dl="png">PNG</button>
                <button class="menu-item" data-dl="svg">SVG</button>
                <button class="menu-item" data-dl="jpg">JPG</button>
              </div>
            </div>

            <div class="menu">
              <button class="btn btn-small">‚ãØ</button>
              <div class="menu-panel hidden" data-panel="more">
                <button class="menu-item" data-act="edit">Edit</button>
                <button class="menu-item" data-act="toggle">${qr.status==="active" ? "Deactivate" : "Activate"}</button>
                <button class="menu-item danger" data-act="delete">Delete</button>
              </div>
            </div>
          </div>
        </td>
      `;

      // wire actions
      const shareBtn = tr.querySelector(`[data-act="share"]`);
      shareBtn.addEventListener("click", async ()=>{
        const url = api.publicUrl(qr.shortCode);

        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(url);
            toast("Link copied");
            return;
          } catch (err) {
            console.error("Clipboard API failed:", err);
          }
        }

        // Fallback: create temporary input element
        try {
          const input = document.createElement("input");
          input.value = url;
          input.style.position = "fixed";
          input.style.opacity = "0";
          document.body.appendChild(input);
          input.select();
          document.execCommand("copy");
          document.body.removeChild(input);
          toast("Link copied");
        } catch (err) {
          console.error("Fallback copy failed:", err);
          alert("Failed to copy. Please copy manually: " + url);
        }
      });

      // download menu toggle
      const dlMenu = tr.querySelectorAll(".menu")[0];
      const moreMenu = tr.querySelectorAll(".menu")[1];
      const dlBtn = dlMenu.querySelector(`[data-act="download"]`);
      const dlPanel = dlMenu.querySelector(`[data-panel="download"]`);
      const moreBtn = moreMenu.querySelector("button");
      const morePanel = moreMenu.querySelector(`[data-panel="more"]`);

      dlBtn.addEventListener("click",(ev)=>{
        ev.stopPropagation();
        closeAllMenus();
        dlPanel.classList.toggle("hidden");
      });
      moreBtn.addEventListener("click",(ev)=>{
        ev.stopPropagation();
        closeAllMenus();
        morePanel.classList.toggle("hidden");
      });

      dlPanel.querySelectorAll("[data-dl]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          window.open(api.renderUrl(qr.id, btn.dataset.dl, 1024), "_blank");
          dlPanel.classList.add("hidden");
        });
      });

      morePanel.querySelector(`[data-act="edit"]`).addEventListener("click", async ()=>{
        editId = qr.id;
        await loadWizardForEdit(qr.id);
        showWizard();
      });

      morePanel.querySelector(`[data-act="toggle"]`).addEventListener("click", async ()=>{
        try{
          const newStatus = qr.status === "active" ? "inactive" : "active";
          await api.toggleStatus(qr.id, newStatus);
          await loadList();
        }catch{
          alert("Failed to update status");
        }
      });

      morePanel.querySelector(`[data-act="delete"]`).addEventListener("click", async ()=>{
        if (!confirm("Delete this QR code?")) return;
        try{
          await api.deleteQRCode(qr.id);
          await loadList();
        }catch{
          alert("Failed to delete");
        }
      });

      tbody.appendChild(tr);
    }
  }catch(err){
    tbody.innerHTML = `<tr><td colspan="7" style="padding:18px; color:#dc2626">Failed to load (check backend + token)</td></tr>`;
  }
}

function closeAllMenus(){
  $$(".menu-panel").forEach(p=>p.classList.add("hidden"));
}
document.addEventListener("click", closeAllMenus);

/** =========================
 *  Wizard
 *  ========================= */
// Type card selection
$$(".type-card:not(.disabled)").forEach(card => {
  card.addEventListener("click", ()=> {
    $$(".type-card").forEach(c => c.classList.remove("enabled"));
    card.classList.add("enabled");
    qrType = card.dataset.type || "vcard";
  });
});

$("#wizardBackBtn").addEventListener("click", ()=> {
  showList();
});
$("#toStep2").addEventListener("click", ()=> setStep(2));
$("#toStep3").addEventListener("click", ()=> setStep(3));
$("#backTo1").addEventListener("click", ()=> setStep(1));
$("#backTo2").addEventListener("click", ()=> setStep(2));
$("#backTo1Business").addEventListener("click", ()=> setStep(1));
$("#toStep3Business").addEventListener("click", ()=> setStep(3));
$("#saveBtn").addEventListener("click", saveWizard);

$("#tabPreview").addEventListener("click", ()=>{
  $("#tabPreview").classList.add("active");
  $("#tabQR").classList.remove("active");
  $("#previewPane").classList.remove("hidden");
  $("#qrPane").classList.add("hidden");
});
$("#tabQR").addEventListener("click", ()=>{
  $("#tabQR").classList.add("active");
  $("#tabPreview").classList.remove("active");
  $("#previewPane").classList.add("hidden");
  $("#qrPane").classList.remove("hidden");
});

function resetWizard(){
  state.step = 1;
  state.vcard = { fullName:"", phone:"", email:"", website:"", company:"", title:"", summary:"", profileImage:"", socialLinks:[] };
  state.businesspage = {
    companyName: "", title: "", subtitle: "", businessImage: "", fullName: "", phone: "", altPhone: "",
    website: "", email: "", street: "", postalCode: "", city: "", state: "", country: "",
    hoursMode: "ampm",
    openingHours: {
      monFri: { enabled: true, start: "10:00 AM", end: "08:00 PM" },
      mon: { enabled: false, start: "", end: "" }, tue: { enabled: false, start: "", end: "" },
      wed: { enabled: false, start: "", end: "" }, thu: { enabled: false, start: "", end: "" },
      fri: { enabled: false, start: "", end: "" }, sat: { enabled: false, start: "", end: "" },
      sun: { enabled: false, start: "", end: "" }
    },
    facilities: [], summary: "", socialLinks: []
  };
  state.design = { primaryColor:"#6594FF", secondaryColor:"#FFFFFF", pattern:"square", frame:"none", logo:"" };
  state.qrName = "";
  editId = null;
  qrType = "vcard";

  // Reset type cards
  $$(".type-card").forEach(c => c.classList.remove("enabled"));
  const vcardCard = $(".type-card[data-type='vcard']");
  if (vcardCard) vcardCard.classList.add("enabled");

  // reset vCard inputs
  $("#primaryColor").value = state.design.primaryColor;
  $("#secondaryColor").value = state.design.secondaryColor;
  $("#fullName").value = "";
  $("#phone").value = "";
  $("#email").value = "";
  $("#website").value = "";
  $("#company").value = "";
  $("#title").value = "";
  $("#summary").value = "";
  $("#qrName").value = "";
  $("#profilePath").textContent = "";
  $("#logoPath").textContent = "";
  $("#profilePreviewWrap").classList.add("hidden");
  $("#logoPreviewWrap").classList.add("hidden");
  $("#socialList").innerHTML = "";

  // reset business page inputs
  $("#businessPrimaryColor").value = state.design.primaryColor;
  $("#businessSecondaryColor").value = state.design.secondaryColor;
  $("#businessCompanyName").value = "";
  $("#businessTitle").value = "";
  $("#businessSubtitle").value = "";
  $("#businessFullName").value = "";
  $("#businessPhone").value = "";
  $("#businessAltPhone").value = "";
  $("#businessWebsite").value = "";
  $("#businessEmail").value = "";
  $("#businessStreet").value = "";
  $("#businessPostalCode").value = "";
  $("#businessCity").value = "";
  $("#businessState").value = "";
  $("#businessCountry").value = "";
  $("#businessSummary").value = "";
  $("#businessQrName").value = "";
  $("#businessImagePath").textContent = "";
  $("#businessImagePreviewWrap").classList.add("hidden");
  $("#businessSocialList").innerHTML = "";
  $$("[data-facility]").forEach(btn => btn.classList.remove("active"));
  $$("[data-hours-mode]").forEach(btn => btn.classList.remove("active"));
  const ampmBtn = $("[data-hours-mode='ampm']");
  if (ampmBtn) ampmBtn.classList.add("active");

  setStep(1);
  updatePreview();
  updateWizardTitle();
}

function setStep(n){
  state.step = n;
  $("#step1").classList.toggle("hidden", n!==1);

  // Show correct step 2 based on type
  if (qrType === "vcard") {
    $("#step2vcard").classList.toggle("hidden", n!==2);
    $("#step2business").classList.add("hidden");
  } else {
    $("#step2business").classList.toggle("hidden", n!==2);
    $("#step2vcard").classList.add("hidden");
  }

  $("#step3").classList.toggle("hidden", n!==3);

  $("#st1").classList.toggle("active", n===1);
  $("#st2").classList.toggle("active", n===2);
  $("#st3").classList.toggle("active", n===3);

  // label save button
  $("#saveBtn").textContent = editId ? "Update QR Code" : "Create QR Code";
  updateWizardTitle();
  updatePreview();
}

function updateWizardTitle(){
  const typeName = qrType === "vcard" ? "vCard" : "Business Page";
  $("#wizardTitle").textContent = (editId ? "Edit" : "Create") + " " + typeName + " QR code";
}

/* Collapsible sections */
$$(".section").forEach(sec=>{
  const head = sec.querySelector(".section-h");
  const chev = sec.querySelector(".chev");
  const body = sec.querySelector(".section-b");
  const open = sec.dataset.open === "true";

  if (!open && body) body.classList.add("hidden");
  if (open && chev) chev.classList.add("open");

  head.addEventListener("click", ()=>{
    const isHidden = body.classList.toggle("hidden");
    chev.classList.toggle("open", !isHidden);
  });
});

/* Presets */
const colorPresets = [
  ["#6594FF", "#FFFFFF"],
  ["#E0E0E0", "#000000"],
  ["#E0E0E0", "#6594FF"],
  ["#D4E5FF", "#6594FF"],
  ["#A594FF", "#FFFFFF"],
  ["#66CC99", "#000000"],
  ["#FFAA44", "#FFFFFF"],
];

(function initPresets(){
  const row = $("#presetRow");
  row.innerHTML = "";
  colorPresets.forEach((c, i)=>{
    const btn = document.createElement("div");
    btn.className = "preset";
    btn.title = c[0] + " / " + c[1];
    btn.innerHTML = `<div style="background:${c[0]}"></div><div style="background:${c[1]}"></div>`;
    btn.addEventListener("click", ()=>{
      state.design.primaryColor = c[0];
      state.design.secondaryColor = c[1];
      $("#primaryColor").value = c[0];
      $("#secondaryColor").value = c[1];
      updatePreview();
    });
    row.appendChild(btn);
  });
})();

/* Chips: patterns + frames */
(function initChips(){
  const patterns = ["square","rounded","dots"];
  const frames = ["none","frame1","frame2","frame3","frame4"];

  const pWrap = $("#patternChips");
  pWrap.innerHTML = "";
  patterns.forEach(p=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "chip";
    b.textContent = p[0].toUpperCase()+p.slice(1);
    b.addEventListener("click", ()=>{
      state.design.pattern = p;
      syncChips();
      updatePreview();
    });
    b.dataset.val = p;
    pWrap.appendChild(b);
  });

  const fWrap = $("#frameChips");
  fWrap.innerHTML = "";
  frames.forEach(f=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "chip";
    b.textContent = f==="none" ? "None" : ("Frame " + f.slice(-1));
    b.addEventListener("click", ()=>{
      state.design.frame = f;
      syncChips();
      updatePreview();
    });
    b.dataset.val = f;
    fWrap.appendChild(b);
  });

  function syncChips(){
    pWrap.querySelectorAll(".chip").forEach(x=>x.classList.toggle("active", x.dataset.val===state.design.pattern));
    fWrap.querySelectorAll(".chip").forEach(x=>x.classList.toggle("active", x.dataset.val===state.design.frame));
  }
  window.__syncChips = syncChips;
  syncChips();
})();

/* Bind inputs */
$("#primaryColor").addEventListener("input",(e)=>{
  state.design.primaryColor = e.target.value;
  updatePreview();
});
$("#secondaryColor").addEventListener("input",(e)=>{
  state.design.secondaryColor = e.target.value;
  updatePreview();
});
$("#fullName").addEventListener("input",(e)=>{
  state.vcard.fullName = e.target.value;
  updatePreview();
});
$("#phone").addEventListener("input",(e)=> state.vcard.phone = e.target.value);
$("#email").addEventListener("input",(e)=> state.vcard.email = e.target.value);
$("#website").addEventListener("input",(e)=> state.vcard.website = e.target.value);
$("#company").addEventListener("input",(e)=> { state.vcard.company = e.target.value; updatePreview(); });
$("#title").addEventListener("input",(e)=> { state.vcard.title = e.target.value; updatePreview(); });
$("#summary").addEventListener("input",(e)=> { state.vcard.summary = e.target.value; updatePreview(); });
$("#qrName").addEventListener("input",(e)=> state.qrName = e.target.value);

/* Social */
$("#addSocialBtn").addEventListener("click", ()=>{
  const platform = $("#socialPlatform").value;
  const url = $("#socialUrl").value.trim();
  if (!url) return;

  state.vcard.socialLinks.push({ platform, url });
  $("#socialUrl").value = "";
  renderSocialList();
  updatePreview();
});

function renderSocialList(){
  const list = $("#socialList");
  list.innerHTML = "";
  state.vcard.socialLinks.forEach((s, idx)=>{
    const row = document.createElement("div");
    row.className = "card";
    row.style.padding = "10px 12px";
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.justifyContent = "space-between";
    row.innerHTML = `
      <div style="display:flex;flex-direction:column">
        <div style="font-weight:700; font-size:13px">${escapeHtml(s.platform)}</div>
        <div class="smallmuted">${escapeHtml(s.url)}</div>
      </div>
      <button class="btn btn-small btn-danger" type="button">Remove</button>
    `;
    row.querySelector("button").addEventListener("click", ()=>{
      state.vcard.socialLinks.splice(idx, 1);
      renderSocialList();
      updatePreview();
    });
    list.appendChild(row);
  });
}

/* Business Page inputs */
$("#businessPrimaryColor").addEventListener("input",(e)=>{
  state.design.primaryColor = e.target.value;
  updatePreview();
});
$("#businessSecondaryColor").addEventListener("input",(e)=>{
  state.design.secondaryColor = e.target.value;
  updatePreview();
});
$("#businessCompanyName").addEventListener("input",(e)=> { state.businesspage.companyName = e.target.value; updatePreview(); });
$("#businessTitle").addEventListener("input",(e)=> { state.businesspage.title = e.target.value; updatePreview(); });
$("#businessSubtitle").addEventListener("input",(e)=> { state.businesspage.subtitle = e.target.value; updatePreview(); });
$("#businessFullName").addEventListener("input",(e)=> state.businesspage.fullName = e.target.value);
$("#businessPhone").addEventListener("input",(e)=> state.businesspage.phone = e.target.value);
$("#businessAltPhone").addEventListener("input",(e)=> state.businesspage.altPhone = e.target.value);
$("#businessWebsite").addEventListener("input",(e)=> state.businesspage.website = e.target.value);
$("#businessEmail").addEventListener("input",(e)=> state.businesspage.email = e.target.value);
$("#businessStreet").addEventListener("input",(e)=> state.businesspage.street = e.target.value);
$("#businessPostalCode").addEventListener("input",(e)=> state.businesspage.postalCode = e.target.value);
$("#businessCity").addEventListener("input",(e)=> state.businesspage.city = e.target.value);
$("#businessState").addEventListener("input",(e)=> state.businesspage.state = e.target.value);
$("#businessCountry").addEventListener("input",(e)=> state.businesspage.country = e.target.value);
$("#businessSummary").addEventListener("input",(e)=> state.businesspage.summary = e.target.value);
$("#businessQrName").addEventListener("input",(e)=> state.qrName = e.target.value);

// Business hours mode
$$("[data-hours-mode]").forEach(btn => {
  btn.addEventListener("click", ()=> {
    $$("[data-hours-mode]").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    state.businesspage.hoursMode = btn.dataset.hoursMode;
  });
});

// Business facilities
$("#facilitiesChips").querySelectorAll("[data-facility]").forEach(btn => {
  btn.addEventListener("click", ()=> {
    btn.classList.toggle("active");
    const facility = btn.dataset.facility;
    const idx = state.businesspage.facilities.indexOf(facility);
    if (idx > -1) {
      state.businesspage.facilities.splice(idx, 1);
    } else {
      state.businesspage.facilities.push(facility);
    }
  });
});

// Business social
$("#addBusinessSocialBtn").addEventListener("click", ()=>{
  const platform = $("#businessSocialPlatform").value;
  const url = $("#businessSocialUrl").value.trim();
  if (!url) return;

  state.businesspage.socialLinks.push({ platform, url });
  $("#businessSocialUrl").value = "";
  renderBusinessSocialList();
  updatePreview();
});

function renderBusinessSocialList(){
  const list = $("#businessSocialList");
  list.innerHTML = "";
  state.businesspage.socialLinks.forEach((s, idx)=>{
    const row = document.createElement("div");
    row.className = "card";
    row.style.padding = "10px 12px";
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.justifyContent = "space-between";
    row.innerHTML = `
      <div style="display:flex;flex-direction:column">
        <div style="font-weight:700; font-size:13px">${escapeHtml(s.platform)}</div>
        <div class="smallmuted">${escapeHtml(s.url)}</div>
      </div>
      <button class="btn btn-small btn-danger" type="button">Remove</button>
    `;
    row.querySelector("button").addEventListener("click", ()=>{
      state.businesspage.socialLinks.splice(idx, 1);
      renderBusinessSocialList();
      updatePreview();
    });
    list.appendChild(row);
  });
}

// Business preset colors
(function initBusinessPresets(){
  const row = $("#businessPresetRow");
  if (!row) return;
  row.innerHTML = "";
  colorPresets.forEach((c, i)=>{
    const btn = document.createElement("div");
    btn.className = "preset";
    btn.title = c[0] + " / " + c[1];
    btn.innerHTML = `<div style="background:${c[0]}"></div><div style="background:${c[1]}"></div>`;
    btn.addEventListener("click", ()=>{
      state.design.primaryColor = c[0];
      state.design.secondaryColor = c[1];
      $("#businessPrimaryColor").value = c[0];
      $("#businessSecondaryColor").value = c[1];
      updatePreview();
    });
    row.appendChild(btn);
  });
})();

/* Uploads */
$("#profileUploadBtn").addEventListener("click", ()=> $("#profileFile").click());
$("#logoUploadBtn").addEventListener("click", ()=> $("#logoFile").click());
$("#businessImageUploadBtn").addEventListener("click", ()=> $("#businessImageFile").click());

$("#profileFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;
  try{
    const up = await api.uploadFile(file);
    // expect { url: "/files/..." } or similar
    state.vcard.profileImage = up.url || up.path || "";
    $("#profilePath").textContent = state.vcard.profileImage;
    if (state.vcard.profileImage){
      $("#profilePreview").src = API_BASE + state.vcard.profileImage;
      $("#profilePreviewWrap").classList.remove("hidden");
    }
    updatePreview();
  }catch{
    alert("Failed to upload profile image");
  }finally{
    e.target.value = "";
  }
});

$("#logoFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;
  try{
    const up = await api.uploadFile(file);
    state.design.logo = up.url || up.path || "";
    $("#logoPath").textContent = state.design.logo;
    if (state.design.logo){
      $("#logoPreview").src = API_BASE + state.design.logo;
      $("#logoPreviewWrap").classList.remove("hidden");
    }
    updatePreview();
  }catch{
    alert("Failed to upload logo");
  }finally{
    e.target.value = "";
  }
});

$("#businessImageFile").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;
  try{
    const up = await api.uploadFile(file);
    state.businesspage.businessImage = up.url || up.path || "";
    $("#businessImagePath").textContent = state.businesspage.businessImage;
    if (state.businesspage.businessImage){
      $("#businessImagePreview").src = API_BASE + state.businesspage.businessImage;
      $("#businessImagePreviewWrap").classList.remove("hidden");
    }
    updatePreview();
  }catch{
    alert("Failed to upload business image");
  }finally{
    e.target.value = "";
  }
});

/* Preview rendering */
function updatePreview(){
  const scr = $("#phoneScreen");
  const p = state.design.primaryColor || "#6594FF";
  scr.style.background = `linear-gradient(180deg, ${p} 0%, ${p}dd 100%)`;

  const av = $("#phoneAvatar");
  const nm = $("#phoneName");
  const cards = $("#phoneCards");

  if (qrType === "vcard") {
    // vCard preview
    if (state.vcard.profileImage){
      av.src = API_BASE + state.vcard.profileImage;
      av.classList.remove("hidden");
    } else {
      av.classList.add("hidden");
    }

    if (state.vcard.fullName){
      nm.textContent = state.vcard.fullName;
      nm.classList.remove("hidden");
    } else {
      nm.classList.add("hidden");
    }

    cards.innerHTML = "";

    function addRow(icon, label, enabled){
      if (!enabled) return;
      const div = document.createElement("div");
      div.className = "rowitem";
      div.innerHTML = `
        <div class="l"><span>${icon}</span><span>${label}</span></div>
        <span class="arrow">‚Üí</span>
      `;
      cards.appendChild(div);
    }

    addRow("üìû", "Contact", !!(state.vcard.phone || state.vcard.email || state.vcard.website));
    addRow("üè¢", "Company", !!(state.vcard.company || state.vcard.title));
    addRow("üìù", "Summary", !!(state.vcard.summary));
    addRow("üëç", "Social media", !!(state.vcard.socialLinks && state.vcard.socialLinks.length));
  } else {
    // Business Page preview
    if (state.businesspage.businessImage){
      av.src = API_BASE + state.businesspage.businessImage;
      av.classList.remove("hidden");
    } else {
      av.classList.add("hidden");
    }

    if (state.businesspage.companyName){
      nm.textContent = state.businesspage.companyName;
      nm.classList.remove("hidden");
    } else {
      nm.classList.add("hidden");
    }

    cards.innerHTML = "";

    function addBusinessRow(icon, label, enabled){
      if (!enabled) return;
      const div = document.createElement("div");
      div.className = "rowitem";
      div.innerHTML = `
        <div class="l"><span>${icon}</span><span>${label}</span></div>
        <span class="arrow">‚Üí</span>
      `;
      cards.appendChild(div);
    }

    addBusinessRow("üïê", "Open hours", state.businesspage.hoursMode === "24/7" || !!(state.businesspage.openingHours.monFri.enabled));
    addBusinessRow("üìç", "Location", !!(state.businesspage.street || state.businesspage.city));
    addBusinessRow("‚ò∫Ô∏è", "Facilities", !!(state.businesspage.facilities && state.businesspage.facilities.length));
  }
}

/* Save wizard */
async function saveWizard(){
  let name, requiredField;

  if (qrType === "vcard") {
    name = ($("#qrName").value || "").trim();
    requiredField = ($("#fullName").value || "").trim();
    if (!name || !requiredField){
      alert("Please fill required fields: Full name and QR code name.");
      return;
    }

    state.qrName = name;
    state.vcard.fullName = requiredField;

    const payload = {
      name: state.qrName,
      type: "vcard",
      vcard: state.vcard,
      design: state.design
    };

    $("#saveBtn").disabled = true;
    try{
      if (editId){
        await api.updateQRCode(editId, payload);
        toast("Updated");
      } else {
        await api.createQRCode(payload);
        toast("Created");
      }
      showList();
    }catch(err){
      console.error(err);
      alert("Failed to save (check backend endpoints + auth).");
    }finally{
      $("#saveBtn").disabled = false;
    }
  } else {
    // Business Page
    name = ($("#businessQrName").value || "").trim();
    requiredField = ($("#businessCompanyName").value || "").trim();
    if (!name || !requiredField){
      alert("Please fill required fields: Company name and QR code name.");
      return;
    }

    state.qrName = name;
    state.businesspage.companyName = requiredField;

    const payload = {
      name: state.qrName,
      type: "businesspage",
      businesspage: state.businesspage,
      design: state.design
    };

    $("#saveBtn").disabled = true;
    try{
      if (editId){
        await api.updateQRCode(editId, payload);
        toast("Updated");
      } else {
        await api.createQRCode(payload);
        toast("Created");
      }
      showList();
    }catch(err){
      console.error(err);
      alert("Failed to save (check backend endpoints + auth).");
    }finally{
      $("#saveBtn").disabled = false;
    }
  }
}

/* Load wizard for edit */
async function loadWizardForEdit(id){
  resetWizard();
  editId = id;
  try{
    const d = await api.getQRCode(id);
    state.qrName = d.name || "";
    state.vcard = Object.assign(state.vcard, d.vcard || {});
    state.design = Object.assign(state.design, d.design || {});

    // sync inputs
    $("#qrName").value = state.qrName;
    $("#fullName").value = state.vcard.fullName || "";
    $("#phone").value = state.vcard.phone || "";
    $("#email").value = state.vcard.email || "";
    $("#website").value = state.vcard.website || "";
    $("#company").value = state.vcard.company || "";
    $("#title").value = state.vcard.title || "";
    $("#summary").value = state.vcard.summary || "";
    $("#primaryColor").value = state.design.primaryColor || "#6594FF";
    $("#secondaryColor").value = state.design.secondaryColor || "#FFFFFF";

    if (state.vcard.profileImage){
      $("#profilePath").textContent = state.vcard.profileImage;
      $("#profilePreview").src = API_BASE + state.vcard.profileImage;
      $("#profilePreviewWrap").classList.remove("hidden");
    }
    if (state.design.logo){
      $("#logoPath").textContent = state.design.logo;
      $("#logoPreview").src = API_BASE + state.design.logo;
      $("#logoPreviewWrap").classList.remove("hidden");
    }

    if (window.__syncChips) window.__syncChips();
    renderSocialList();
    updateWizardTitle();
    updatePreview();
  }catch(e){
    alert("Failed to load QR for editing.");
  }
}

/** =========================
 *  Page switching
 *  ========================= */
function showList(){
  view = "list";
  $("#listPage").classList.remove("hidden");
  $("#wizardPage").classList.add("hidden");
  loadList();
}

function showWizard(){
  view = "wizard";
  $("#listPage").classList.add("hidden");
  $("#wizardPage").classList.remove("hidden");
  setStep(1);
  updatePreview();
  updateWizardTitle();

  // switch to Preview tab by default
  $("#tabPreview").click();

  // If editing, show QR preview in QR tab once saved (optional)
}

/** =========================
 *  Boot
 *  ========================= */
(function boot(){
  if (api.token){
    showApp();
  } else {
    showLogin();
  }
})();
</script>
</body>
</html>
